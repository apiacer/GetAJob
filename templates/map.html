{% extends "layout.html" %}

{% block title %}Jobs Map ‚Äî GetAJob{% endblock %}

{% block head %}
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<style>
  .map-page-container {
    max-width: 1150px;
    margin: 0 auto;
    padding: 24px 0 40px;
  }

  .map-layout {
    display: flex;
    gap: 20px;
    align-items: flex-start;
  }

  .map-main {
    flex: 1;
    min-width: 0;
  }

  .map-sidebar {
    width: 320px;
    flex-shrink: 0;
  }
  
  #map {
    width: 100%;
    border-radius: 12px;
    border: 1px solid #ddd;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
    overflow: hidden;
  }
  .map-controls {
    background: #fff;
    border-radius: 10px;
    border: 1px solid #eee;
    padding: 10px 12px;
    margin-bottom: 16px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }

  .map-controls input,
  .map-controls select {
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 14px;
  }

  #addressInput {
    flex: 1;
    min-width: 180px;
  }

  #radiusSelect {
    width: 120px;
  }

  .job-list-container {
    background: #fff;
    border-radius: 10px;
    border: 1px solid #eee;
    padding: 12px 14px;
    max-height: 480px;
    overflow-y: auto;
  }

  .job-item-link {
    text-decoration: none;
    color: inherit;
    display: block;
    padding: 8px 6px;
    border-bottom: 1px solid #f1f1f1;
  }

  .job-item-link:last-child {
    border-bottom: none;
  }

  .job-title {
    font-weight: 600;
    margin-bottom: 2px;
  }

  .job-location {
    font-size: 13px;
    color: #666;
  }

  .job-distance {
    font-size: 12px;
    color: var(--primary);
    font-weight: 500;
  }

  .loading {
    padding: 18px 8px;
    text-align: center;
    font-size: 14px;
    color: #777;
  }

  @media (max-width: 900px) {
    .map-layout {
      flex-direction: column;
    }
    .map-sidebar {
      width: 100%;
      max-width: none;
    }
    #map {
      height: 380px;
    }
    .job-list-container {
      max-height: 320px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="map-page-container">
  <h1>Jobs Map</h1>
  <p class="text-muted">
    Browse jobs on an interactive map. Use your location or search by city / ZIP.
  </p>

  <div class="map-controls">
    <input
      type="text"
      id="addressInput"
      placeholder="Enter address, city, or ZIP‚Ä¶"
    />
    <select id="radiusSelect">
      <option value="5">5 miles</option>
      <option value="10" selected>10 miles</option>
      <option value="25">25 miles</option>
      <option value="50">50 miles</option>
      <option value="100">100 miles</option>
      <option value="0">Show all</option>
    </select>
    <button id="locateBtn" class="btn btn-outline">
      üìç My Location
    </button>
    <button id="searchBtn" class="btn btn-primary">
      Search
    </button>
  </div>

  <div class="map-layout">
    <div class="map-main">
      <div id="map"></div>
    </div>
    <div class="map-sidebar">
      <div class="job-list-container">
        <h5 style="margin: 0 0 6px;">Jobs</h5>
        <div id="jobsList" class="mt-2">
          <div class="loading">Loading jobs‚Ä¶</div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  let map;
  let jobMarkers;

  document.addEventListener("DOMContentLoaded", () => {
    initMap();
    setupControls();
    loadAllJobs();
  });

  function initMap() {
    map = L.map("map").setView([37.8, -96.9], 4); // USA-ish

    // Use the TILE_URL + attribution from app.context_processor
    L.tileLayer("{{ TILE_URL }}", {
      attribution: "{{ TILE_ATTRIBUTION|safe }}",
      maxZoom: 19,
    }).addTo(map);

    jobMarkers = L.layerGroup().addTo(map);

    // make sure it sizes correctly
    setTimeout(() => map.invalidateSize(), 200);
  }

  async function loadAllJobs() {
    const jobsList = document.getElementById("jobsList");
    jobsList.innerHTML = '<div class="loading">Loading jobs‚Ä¶</div>';
    try {
      const res = await fetch("/api/jobs");
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "API error");
      const jobs = data.jobs || [];
      renderJobs(jobs);
      putMarkers(jobs);
    } catch (err) {
      console.error(err);
      jobsList.innerHTML =
        '<div class="loading">Could not load jobs.</div>';
    }
  }

  async function loadNearbyJobs(lat, lng) {
    const radius = document.getElementById("radiusSelect").value || "10";
    const jobsList = document.getElementById("jobsList");
    jobsList.innerHTML = '<div class="loading">Loading nearby jobs‚Ä¶</div>';
    try {
      const url = `/api/jobs_nearby?lat=${lat}&lng=${lng}&radius_miles=${radius}`;
      const res = await fetch(url);
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "API error");
      const jobs = data.jobs || [];
      renderJobs(jobs);
      putMarkers(jobs, [lat, lng]);
    } catch (err) {
      console.error(err);
      jobsList.innerHTML =
        '<div class="loading">Could not load nearby jobs.</div>';
    }
  }

  function renderJobs(jobs) {
    const jobsList = document.getElementById("jobsList");
    if (!jobs.length) {
      jobsList.innerHTML =
        '<div class="loading">No jobs found for this area yet.</div>';
      return;
    }
    jobsList.innerHTML = "";
    jobs.forEach((job) => {
      const a = document.createElement("a");
      a.href = `/job/${job.id}`;
      a.className = "job-item-link";
      a.innerHTML = `
        <div class="job-title">${job.title || "Untitled job"}</div>
        <div class="job-location">
          ${job.short_location || job.location_text || "Location not set"}
        </div>
        ${
          job.distance_miles != null
            ? `<div class="job-distance">${job.distance_miles} miles away</div>`
            : ""
        }
      `;
      jobsList.appendChild(a);
    });
  }

  function putMarkers(jobs, centerOverride) {
    jobMarkers.clearLayers();
    const bounds = [];

    jobs.forEach((job) => {
      if (job.lat == null || job.lng == null) return;
      const lat = job.lat;
      const lng = job.lng;
      const marker = L.marker([lat, lng]);
      marker.bindPopup(
        `<strong>${job.title || "Untitled job"}</strong><br/>
         ${job.short_location || job.location_text || ""}<br/>
         <a href="/job/${job.id}">View job</a>`
      );
      marker.addTo(jobMarkers);
      bounds.push([lat, lng]);
    });

    if (centerOverride) {
      map.setView(centerOverride, 11);
    } else if (bounds.length) {
      map.fitBounds(bounds, { padding: [24, 24] });
    }
  }

  function setupControls() {
    // "My Location"
    document.getElementById("locateBtn").addEventListener("click", () => {
      const btn = document.getElementById("locateBtn");
      if (!navigator.geolocation) {
        alert("Geolocation not supported in this browser.");
        return;
      }
      btn.disabled = true;
      btn.textContent = "Locating‚Ä¶";

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          btn.disabled = false;
          btn.textContent = "üìç My Location";
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          loadNearbyJobs(lat, lng);
        },
        (err) => {
          btn.disabled = false;
          btn.textContent = "üìç My Location";
          alert("Error getting location: " + err.message);
        }
      );
    });

    // Basic search by address (uses your server geocoder helper via /_client_location? nah)
    document.getElementById("searchBtn").addEventListener("click", () => {
      const addr = document.getElementById("addressInput").value.trim();
      if (!addr) {
        // fallback to all jobs again
        loadAllJobs();
        return;
      }
      // cheap client-side geocode using Nominatim
      geocodeAndCenter(addr);
    });

    document
      .getElementById("radiusSelect")
      .addEventListener("change", () => {
        const center = map.getCenter();
        loadNearbyJobs(center.lat, center.lng);
      });
  }

  async function geocodeAndCenter(query) {
    try {
      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(
        query
      )}`;
      const resp = await fetch(url, {
        headers: { "User-Agent": "GetAJob/1.0 (dev-local)" },
      });
      const data = await resp.json();
      if (!data.length) {
        alert("Could not find that location.");
        return;
      }
      const item = data[0];
      const lat = parseFloat(item.lat);
      const lng = parseFloat(item.lon);
      map.setView([lat, lng], 12);
      loadNearbyJobs(lat, lng);
    } catch (e) {
      console.error(e);
      alert("Error looking up that location.");
    }
  }
</script>
{% endblock %}

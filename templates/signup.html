<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sign Up</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/signup.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
  </head>

  <body>
    <a href="/" class="home-link">← Back Home</a>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flashes">
          {% for category, message in messages %}
            <li class="{{ category }}">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <div class="signup-card">
      <h2>Sign Up</h2>

      <form action="/signup" method="post" id="signup-form">
        <div class="form-group">
          <label>First Name</label>
          <input type="text" id="fname" name="fname" required />
        </div>

        <div class="form-group">
          <label>Last Name</label>
          <input type="text" id="lname" name="lname" required />
        </div>

        <div class="form-group">
          <label>Username</label>
          <input type="text" id="username" name="username" required />
          <small id="user-status"></small>
        </div>

        <div class="form-group">
          <label>Email</label>
          <input type="email" id="email" name="email" required />
          <small id="email-status"></small>
        </div>

        <div class="form-group">
          <label>Password</label>
          <input type="password" id="password" name="password" required />
          <small id="pw-strength"></small>
        </div>

        <button id="submit" type="submit" class="signup-btn" disabled>Sign Up</button>

        <div class="login-link">
          <a href="/login">Already have an account? Log in</a>
        </div>
      </form>
    </div>

    <script>

      const emailField = document.getElementById('email');
      const emailStatus = document.getElementById('email-status');

      const pwField = document.getElementById('password');
      const pwStatus = document.getElementById('pw-strength');
      
      const nameInputs = [document.getElementById('fname'), document.getElementById('lname')];

      const usernameField = document.getElementById('username');
      const userStatus = document.getElementById('user-status');

      const submitBtn = document.getElementById('submit');

      // ===== update button =====
      async function update_button() {
        console.log("SCRIPT LOADED");
        if (emailStatus.style.color == "green" && 
            pwStatus.style.color == "green" && 
            userStatus.style.color == "green"){
            submitBtn.disabled = false;
          }
        else{
          submitBtn.disabled = true;
        }
      }

      // ===== Email Check =====
      emailField.addEventListener('input', async () => {
        const valid = /^[^@]+@[^@]+\.[^@]+$/.test(emailField.value);
        emailStatus.textContent = valid ? "Valid email format" : "Invalid email format";
        emailStatus.style.color = valid ? "green" : "red";
        
        // check exist after valid
        if (valid){
          const value = emailField.value.trim();
          try{
            const response = await fetch(`/check_email?email=${encodeURIComponent(value)}`);
            const data = await response.json();
            console.log('Response:', data);

            if (data.exists) {
              emailStatus.textContent = "Oops! This email is already registered. Did you mean to log in?"
              emailStatus.style.color = "red"
            }
          } catch (err) {
            console.error(err);
            emailStatus.textContent = "Error checking email";
            emailStatus.style.color = "orange"
          }
        }
        await update_button();
      });


      // ===== Password Strength =====
      pwField.addEventListener('input', () => {
        const value = pwField.value;
        // at least 1 lowercase, 1 uppercase, 1 digit, 8+ chars
        const strong = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&_]).{8,}$/.test(value);
        pwStatus.textContent = strong
          ? "Strong password"
          : "⚠️ Weak (Use 8+ characters with 1 uppercase, 1 number, and 1 special character.)";
        pwStatus.style.color = strong ? "green" : "orange";
        update_button();
      });

      // add name condition and status
      // ===== Name Fields =====
      nameInputs.forEach(field => {
        field.addEventListener('input', () => {
          field.value = field.value.replace(/[^a-zA-Z]/g, '');
        });
        update_button()
      });

      // ===== Username validation =====
      usernameField.addEventListener('input', async () => {
        const value = usernameField.value.trim(); // remove spaces first
        console.log('Username length:', value.length);
        if (value.length < 4) {
          userStatus.textContent = "Username must be at least 4 characters";
          userStatus.style.color = "red";
          return;
        }

        // Now check backend for uniqueness
        try {
          const response = await fetch(`/check_username?username=${encodeURIComponent(value)}`);
          const data = await response.json(); 
          console.log('Response:', data);      

          if (data.exists) {
            userStatus.textContent = "Username already taken";
            userStatus.style.color = "red";
          } else {
            userStatus.textContent = "Username available";
            userStatus.style.color = "green";
          }
        } catch (err) {
          console.error(err);
          userStatus.textContent = "Error checking username";
          userStatus.style.color = "orange";
        }
        update_button();
      });


    </script>
  </body>
</html>
